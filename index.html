<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workout Tracker Pro</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f0f2f5;
    }

    /* Header with logo */
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-radius: 16px;
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .logo {
      width: 60px;
      height: 60px;
      margin-right: 20px;
      background: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }

    .header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
    }

    .header p {
      margin: 5px 0 0;
      opacity: 0.9;
      font-size: 16px;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }

    h2 {
      color: #1f2937;
      margin-top: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 18px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #4b5563;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 15px;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    button {
      background: #6366f1;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 15px;
      transition: background 0.2s, transform 0.1s;
    }

    button:hover {
      background: #4f46e5;
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    .delete-btn {
      background: #ef4444;
      padding: 6px 12px;
      font-size: 13px;
    }

    .delete-btn:hover {
      background: #dc2626;
    }

    .add-set-btn {
      background: #10b981;
      margin-top: 12px;
    }

    .add-set-btn:hover {
      background: #059669;
    }

    .remove-set-btn {
      background: #f59e0b;
      padding: 4px 10px;
      font-size: 13px;
      margin-left: 10px;
    }

    .entry {
      background: #f9fafb;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #e5e7eb;
      transition: background 0.2s;
    }

    .entry:hover {
      background: #f3f4f6;
    }

    .entry-info {
      flex: 1;
    }

    .entry-date {
      color: #6b7280;
      font-size: 14px;
      margin-top: 4px;
    }

    .status {
      padding: 12px 16px;
      margin: 10px 0;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
    }

    .success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }

    .error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }

    .set-input {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      padding: 8px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .set-input input {
      width: 80px;
      padding: 6px 8px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      opacity: 0.3;
    }

    /* Notes field */
    .notes-field {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 15px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }

    textarea:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Modal styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
    }

    .modal-body {
      padding: 24px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      color: #6b7280;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .close-btn:hover {
      background: #f3f4f6;
    }

    pre {
      margin: 0;
      font-family: 'Monaco', 'Consolas', monospace;
    }

    details summary {
      font-weight: 500;
    }

    small {
      font-size: 13px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">üí™</div>
    <div>
      <h1>Workout Tracker Pro</h1>
      <p>Track your fitness journey</p>
    </div>
  </div>

  <div class="card">
    <h2>üîå Connection Status</h2>
    <div id="status" class="status info">Checking database connection...</div>
  </div>

  <div class="card">
    <h2>‚ûï Add New Workout</h2>
    <div style="margin-bottom: 20px;">
      <button type="button" onclick="showImportModal()" style="background: #8b5cf6;">
        üì• Import or Generate Workout
      </button>
    </div>
    <form id="workoutForm">
      <div class="form-group">
        <label for="date">Date</label>
        <input type="date" id="date" required>
      </div>

      <div class="form-group">
        <label for="type">Type</label>
        <select id="type" required>
          <option value="lift">üèãÔ∏è Weight Training</option>
          <option value="cardio">üèÉ Cardio</option>
          <option value="bjj">ü•ã BJJ</option>
        </select>
      </div>

      <div class="form-group">
        <label for="sessionName">Session Name (optional)</label>
        <input type="text" id="sessionName" placeholder="e.g. Push Day, Leg Day">
      </div>

      <div id="liftFields" style="display:block">
        <div class="form-group">
          <label for="liftName">Exercise Name</label>
          <input type="text" id="liftName" placeholder="e.g. Bench Press">
        </div>
        <div class="form-group">
          <label>Sets</label>
          <div id="setsBuilder">
            <div class="set-input">
              <span>Set 1:</span>
              <input type="number" class="reps" placeholder="Reps" min="1">
              <span>reps √ó</span>
              <input type="number" class="weight" placeholder="Weight" min="0" step="2.5">
              <span>lbs</span>
            </div>
          </div>
          <button type="button" onclick="addSet()" class="add-set-btn">+ Add Set</button>
        </div>
        <div class="form-group">
          <label for="rpe">RPE (1-10, optional)</label>
          <input type="number" id="rpe" min="1" max="10" placeholder="Rate of Perceived Exertion">
        </div>
      </div>

      <div id="cardioFields" style="display:none">
        <div class="form-group">
          <label for="modality">Activity</label>
          <input type="text" id="modality" placeholder="e.g. Running, Cycling, Swimming">
        </div>
        <div class="form-group">
          <label for="duration">Duration (minutes)</label>
          <input type="number" id="duration" placeholder="30" min="1">
        </div>
        <div class="form-group">
          <label for="distance">Distance (optional)</label>
          <input type="number" id="distance" placeholder="3.5" step="0.1" min="0">
        </div>
        <div class="form-group">
          <label for="avgHr">Average Heart Rate (optional)</label>
          <input type="number" id="avgHr" placeholder="145" min="40" max="220">
        </div>
      </div>

      <div id="bjjFields" style="display:none">
        <div class="form-group">
          <label for="technique">Focus/Technique</label>
          <input type="text" id="technique" placeholder="e.g. Guard passing, Submissions">
        </div>
        <div class="form-group">
          <label for="rounds">Number of Rounds</label>
          <input type="number" id="rounds" placeholder="5" min="1">
        </div>
        <div class="form-group">
          <label for="roundLength">Round Length (minutes)</label>
          <input type="number" id="roundLength" placeholder="5" min="1">
        </div>
      </div>

      <div class="notes-field">
        <label for="notes">Notes (optional)</label>
        <textarea id="notes" placeholder="How did you feel? Any PRs? Things to remember..."></textarea>
      </div>

      <button type="submit">Add Workout</button>
    </form>
  </div>

  <div class="card">
    <h2>üìä Recent Workouts</h2>
    <div id="workoutsList">Loading...</div>
  </div>

  <script>
    // API configuration
    const API_URL = 'http://localhost:3000/api';

    let setCount = 1;

    // Add a new set input
    function addSet() {
      setCount++;
      const setsBuilder = document.getElementById('setsBuilder');
      const newSet = document.createElement('div');
      newSet.className = 'set-input';
      newSet.innerHTML = `
        <span>Set ${setCount}:</span>
        <input type="number" class="reps" placeholder="Reps" min="1">
        <span>reps √ó</span>
        <input type="number" class="weight" placeholder="Weight" min="0" step="2.5">
        <span>lbs</span>
        <button type="button" onclick="this.parentElement.remove(); setCount--;" class="remove-set-btn">Remove</button>
      `;
      setsBuilder.appendChild(newSet);
    }

    // Get today's date
    document.getElementById('date').value = new Date().toISOString().split('T')[0];

    // Show/hide form fields based on workout type
    document.getElementById('type').addEventListener('change', (e) => {
      const type = e.target.value;
      document.getElementById('liftFields').style.display = type === 'lift' ? 'block' : 'none';
      document.getElementById('cardioFields').style.display = type === 'cardio' ? 'block' : 'none';
      document.getElementById('bjjFields').style.display = type === 'bjj' ? 'block' : 'none';
    });

    // Check API connection
    async function checkConnection() {
      try {
        const response = await fetch(`${API_URL}/stats`);
        if (response.ok) {
          const data = await response.json();
          document.getElementById('status').className = 'status success';
          document.getElementById('status').textContent = `‚úÖ Connected to database (${data.total_workouts} workouts tracked)`;
        } else {
          throw new Error('API not responding');
        }
      } catch (error) {
        document.getElementById('status').className = 'status error';
        document.getElementById('status').textContent = '‚ùå Cannot connect to database. Server may not be running.';
      }
    }

    // Load workouts from API
    async function loadWorkouts() {
      try {
        const response = await fetch(`${API_URL}/entries`);
        const entries = await response.json();

        const container = document.getElementById('workoutsList');

        if (entries.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
              </svg>
              <p>No workouts yet. Start tracking above!</p>
            </div>
          `;
          return;
        }

        // Show only the 10 most recent
        const recent = entries.slice(0, 10);

        container.innerHTML = recent.map(entry => {
          const icon = entry.type === 'lift' ? 'üèãÔ∏è' : entry.type === 'cardio' ? 'üèÉ' : 'ü•ã';
          return `
            <div class="entry">
              <div class="entry-info">
                <strong>${icon} ${getEntryTitle(entry)}</strong>
                <div class="entry-date">${formatDate(entry.date)} ${entry.session_name ? `‚Ä¢ ${entry.session_name}` : ''}</div>
                <div style="color: #6b7280; font-size: 14px; margin-top: 4px;">
                  ${getEntryDetails(entry)}
                  ${entry.notes ? `<br><em>${entry.notes}</em>` : ''}
                </div>
              </div>
              <button class="delete-btn" onclick="deleteEntry(${entry.id})">Delete</button>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error loading workouts:', error);
        document.getElementById('workoutsList').innerHTML = '<p style="color: #ef4444;">Error loading workouts</p>';
      }
    }

    // Format date nicely
    function formatDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      if (date.toDateString() === today.toDateString()) {
        return 'Today';
      } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
      }

      return date.toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric'
      });
    }

    // Get entry title
    function getEntryTitle(entry) {
      if (entry.type === 'lift') {
        return entry.lift_name || 'Weight Training';
      } else if (entry.type === 'cardio') {
        return entry.modality || 'Cardio';
      } else if (entry.type === 'bjj') {
        return entry.technique || 'BJJ Training';
      }
      return entry.type.toUpperCase();
    }

    // Get display details for an entry
    function getEntryDetails(entry) {
      if (entry.type === 'lift') {
        const sets = entry.sets || [];
        const totalVolume = sets.reduce((sum, set) => sum + (set.reps * set.weight), 0);
        let details = `${sets.length} sets`;
        if (totalVolume > 0) details += ` ‚Ä¢ ${totalVolume.toLocaleString()} lbs total`;
        if (entry.rpe) details += ` ‚Ä¢ RPE ${entry.rpe}`;
        return details;
      } else if (entry.type === 'cardio') {
        let details = `${entry.duration || 0} minutes`;
        if (entry.distance) details += ` ‚Ä¢ ${entry.distance} ${entry.distance_unit || 'miles'}`;
        if (entry.avg_hr) details += ` ‚Ä¢ ${entry.avg_hr} bpm`;
        return details;
      } else if (entry.type === 'bjj') {
        return `${entry.rounds || 0} rounds √ó ${entry.round_length || 5} minutes`;
      }
      return '';
    }

    // Handle form submission
    document.getElementById('workoutForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const type = document.getElementById('type').value;
      const date = document.getElementById('date').value;
      const sessionName = document.getElementById('sessionName').value;
      const notes = document.getElementById('notes').value;

      let data = { type, date, session_name: sessionName, notes };

      if (type === 'lift') {
        data.lift_name = document.getElementById('liftName').value;
        data.rpe = document.getElementById('rpe').value || null;

        // Collect sets from individual inputs
        data.sets = [];
        const setInputs = document.querySelectorAll('.set-input');
        setInputs.forEach(setDiv => {
          const reps = setDiv.querySelector('.reps').value;
          const weight = setDiv.querySelector('.weight').value;
          if (reps && weight) {
            data.sets.push({
              reps: parseInt(reps),
              weight: parseFloat(weight)
            });
          }
        });

        if (data.sets.length === 0) {
          alert('Please add at least one set');
          return;
        }

        data.unit = 'lbs';
      } else if (type === 'cardio') {
        data.modality = document.getElementById('modality').value;
        data.duration = parseInt(document.getElementById('duration').value) || null;
        data.distance = parseFloat(document.getElementById('distance').value) || null;
        data.distance_unit = data.distance ? 'miles' : null;
        data.avg_hr = parseInt(document.getElementById('avgHr').value) || null;
      } else if (type === 'bjj') {
        data.technique = document.getElementById('technique').value;
        data.rounds = parseInt(document.getElementById('rounds').value) || null;
        data.round_length = parseInt(document.getElementById('roundLength').value) || 5;
      }

      try {
        const response = await fetch(`${API_URL}/entries`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          // Reset form
          document.getElementById('workoutForm').reset();
          document.getElementById('date').value = new Date().toISOString().split('T')[0];

          // Reset sets builder
          document.getElementById('setsBuilder').innerHTML = `
            <div class="set-input">
              <span>Set 1:</span>
              <input type="number" class="reps" placeholder="Reps" min="1">
              <span>reps √ó</span>
              <input type="number" class="weight" placeholder="Weight" min="0" step="2.5">
              <span>lbs</span>
            </div>
          `;
          setCount = 1;

          // Reload workouts
          loadWorkouts();
          checkConnection();
        } else {
          const error = await response.json();
          alert('Error: ' + error.error);
        }
      } catch (error) {
        alert('Error adding workout: ' + error.message);
      }
    });

    // Delete an entry
    async function deleteEntry(id) {
      if (!confirm('Delete this workout?')) return;

      try {
        const response = await fetch(`${API_URL}/entries/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          loadWorkouts();
          checkConnection();
        } else {
          alert('Error deleting workout');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Initialize
    checkConnection();
    loadWorkouts();

    // Refresh every 30 seconds
    setInterval(() => {
      loadWorkouts();
      checkConnection();
    }, 30000);

    // Import Modal Functions
    function showImportModal() {
      document.getElementById('importModal').style.display = 'flex';
      document.getElementById('importDate').value = document.getElementById('date').value;
      document.getElementById('importStatus').innerHTML = '';

      // Load saved API key and provider
      const savedKey = localStorage.getItem('workout_ai_key');
      const savedProvider = localStorage.getItem('workout_ai_provider') || 'openai';
      if (savedKey) {
        document.getElementById('apiKey').value = savedKey;
      }
      document.getElementById('aiProvider').value = savedProvider;
      updateProviderUI();
    }

    // Update UI based on selected provider
    function updateProviderUI() {
      const provider = document.getElementById('aiProvider').value;
      document.getElementById('customEndpointGroup').style.display =
        provider === 'custom' ? 'block' : 'none';
    }

    // Save API settings
    function saveAPISettings() {
      const apiKey = document.getElementById('apiKey').value;
      const provider = document.getElementById('aiProvider').value;
      if (apiKey) {
        localStorage.setItem('workout_ai_key', apiKey);
        localStorage.setItem('workout_ai_provider', provider);
        if (provider === 'custom') {
          localStorage.setItem('workout_ai_endpoint', document.getElementById('customEndpoint').value);
        }
      }
    }

    // Generate workout with AI
    async function generateWithAI() {
      const apiKey = document.getElementById('apiKey').value;
      const provider = document.getElementById('aiProvider').value;
      const prompt = document.getElementById('workoutPrompt').value;
      const statusDiv = document.getElementById('aiStatus');

      if (!apiKey) {
        statusDiv.innerHTML = '<p style="color: #ef4444;">Please enter your API key</p>';
        return;
      }

      if (!prompt) {
        statusDiv.innerHTML = '<p style="color: #ef4444;">Please describe the workout you want</p>';
        return;
      }

      // Save settings for next time
      saveAPISettings();

      statusDiv.innerHTML = '<p style="color: #3b82f6;">ü§ñ Generating workout plan...</p>';

      try {
        let response;
        const systemPrompt = `You are a fitness coach. Generate a workout plan in this exact JSON format:
{
  "session": "session name",
  "type": "lift",
  "exercises": [
    {
      "name": "exercise name",
      "sets": [
        {"reps": number, "weight": number}
      ],
      "rpe": number (1-10, optional)
    }
  ],
  "notes": "optional notes"
}
For cardio use: {"type": "cardio", "modality": "activity", "duration": minutes, "distance": number}
For BJJ use: {"type": "bjj", "technique": "focus", "rounds": number, "round_length": minutes}`;

        if (provider === 'openai') {
          response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'gpt-4',
              messages: [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: prompt }
              ],
              temperature: 0.7
            })
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error?.message || 'API request failed');
          }

          const content = data.choices[0].message.content;
          // Extract JSON from the response
          const jsonMatch = content.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            document.getElementById('jsonInput').value = jsonMatch[0];
            statusDiv.innerHTML = '<p style="color: #10b981;">‚úÖ Workout plan generated! Review below and import.</p>';
          } else {
            throw new Error('Could not parse workout plan from response');
          }

        } else if (provider === 'anthropic') {
          response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
              model: 'claude-3-sonnet-20240229',
              max_tokens: 1000,
              messages: [{
                role: 'user',
                content: `${systemPrompt}\n\nUser request: ${prompt}`
              }]
            })
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error?.message || 'API request failed');
          }

          const content = data.content[0].text;
          const jsonMatch = content.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            document.getElementById('jsonInput').value = jsonMatch[0];
            statusDiv.innerHTML = '<p style="color: #10b981;">‚úÖ Workout plan generated! Review below and import.</p>';
          } else {
            throw new Error('Could not parse workout plan from response');
          }

        } else if (provider === 'custom') {
          const endpoint = document.getElementById('customEndpoint').value;
          if (!endpoint) {
            throw new Error('Please enter custom endpoint URL');
          }

          // Custom endpoint - adjust this based on your API
          response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              prompt: `${systemPrompt}\n\n${prompt}`,
              max_tokens: 1000
            })
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error('Custom API request failed');
          }

          // Adjust based on your API's response format
          document.getElementById('jsonInput').value = data.result || data.text || JSON.stringify(data);
          statusDiv.innerHTML = '<p style="color: #10b981;">‚úÖ Workout plan generated! Review below and import.</p>';
        }

      } catch (error) {
        console.error('AI Generation error:', error);
        statusDiv.innerHTML = `<p style="color: #ef4444;">‚ùå Error: ${error.message}</p>`;
      }
    }

    // Listen for provider changes
    document.getElementById('aiProvider').addEventListener('change', updateProviderUI);

    function closeImportModal() {
      document.getElementById('importModal').style.display = 'none';
      document.getElementById('jsonInput').value = '';
      document.getElementById('importStatus').innerHTML = '';
    }

    // Close modal when clicking outside
    document.getElementById('importModal').addEventListener('click', (e) => {
      if (e.target.id === 'importModal') {
        closeImportModal();
      }
    });

    // Import and add workouts immediately
    async function importWorkout() {
      const jsonInput = document.getElementById('jsonInput').value;
      const date = document.getElementById('importDate').value;
      const statusDiv = document.getElementById('importStatus');

      if (!jsonInput.trim()) {
        statusDiv.innerHTML = '<p style="color: #ef4444;">Please paste a JSON workout plan</p>';
        return;
      }

      if (!date) {
        statusDiv.innerHTML = '<p style="color: #ef4444;">Please select a date</p>';
        return;
      }

      try {
        const workoutPlan = JSON.parse(jsonInput);
        statusDiv.innerHTML = '<p style="color: #3b82f6;">Importing workouts...</p>';

        // Handle different workout types
        if (workoutPlan.type === 'lift' && workoutPlan.exercises) {
          // Import multiple lift exercises
          let successCount = 0;
          let errorCount = 0;

          for (const exercise of workoutPlan.exercises) {
            const data = {
              type: 'lift',
              date: date,
              session_name: workoutPlan.session || null,
              notes: exercise.notes || workoutPlan.notes || null,
              lift_name: exercise.name,
              sets: exercise.sets || [],
              unit: exercise.unit || 'lbs',
              rpe: exercise.rpe || null
            };

            try {
              const response = await fetch(`${API_URL}/entries`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
              });

              if (response.ok) {
                successCount++;
              } else {
                errorCount++;
              }
            } catch (error) {
              errorCount++;
            }
          }

          statusDiv.innerHTML = `
            <p style="color: #10b981;">
              ‚úÖ Import complete! Added ${successCount} exercises.
              ${errorCount > 0 ? `<br><span style="color: #ef4444;">${errorCount} failed.</span>` : ''}
            </p>
          `;

          // Reload workouts and close modal after delay
          setTimeout(() => {
            loadWorkouts();
            closeImportModal();
          }, 2000);

        } else if (workoutPlan.type === 'cardio') {
          // Import single cardio session
          const data = {
            type: 'cardio',
            date: date,
            session_name: workoutPlan.session || null,
            notes: workoutPlan.notes || null,
            modality: workoutPlan.modality,
            duration: workoutPlan.duration,
            distance: workoutPlan.distance || null,
            distance_unit: workoutPlan.distance ? 'miles' : null,
            avg_hr: workoutPlan.target_hr || workoutPlan.avg_hr || null
          };

          const response = await fetch(`${API_URL}/entries`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (response.ok) {
            statusDiv.innerHTML = '<p style="color: #10b981;">‚úÖ Cardio workout imported!</p>';
            setTimeout(() => {
              loadWorkouts();
              closeImportModal();
            }, 1500);
          } else {
            throw new Error('Failed to import');
          }

        } else if (workoutPlan.type === 'bjj') {
          // Import BJJ session
          const data = {
            type: 'bjj',
            date: date,
            session_name: workoutPlan.session || null,
            notes: workoutPlan.notes || null,
            technique: workoutPlan.technique,
            rounds: workoutPlan.rounds,
            round_length: workoutPlan.round_length || 5
          };

          const response = await fetch(`${API_URL}/entries`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (response.ok) {
            statusDiv.innerHTML = '<p style="color: #10b981;">‚úÖ BJJ session imported!</p>';
            setTimeout(() => {
              loadWorkouts();
              closeImportModal();
            }, 1500);
          } else {
            throw new Error('Failed to import');
          }
        } else {
          throw new Error('Invalid workout type or format');
        }

      } catch (error) {
        console.error('Import error:', error);
        statusDiv.innerHTML = `<p style="color: #ef4444;">‚ùå Error: ${error.message}</p>`;
      }
    }

    // Import as template (populates form without saving)
    function importAsTemplate() {
      const jsonInput = document.getElementById('jsonInput').value;
      const statusDiv = document.getElementById('importStatus');

      if (!jsonInput.trim()) {
        statusDiv.innerHTML = '<p style="color: #ef4444;">Please paste a JSON workout plan</p>';
        return;
      }

      try {
        const workoutPlan = JSON.parse(jsonInput);

        // Set the workout type
        document.getElementById('type').value = workoutPlan.type;
        document.getElementById('type').dispatchEvent(new Event('change'));

        // Set session name if provided
        if (workoutPlan.session) {
          document.getElementById('sessionName').value = workoutPlan.session;
        }

        // Set notes if provided
        if (workoutPlan.notes) {
          document.getElementById('notes').value = workoutPlan.notes;
        }

        // Handle different workout types
        if (workoutPlan.type === 'lift' && workoutPlan.exercises && workoutPlan.exercises[0]) {
          // Use first exercise as template
          const firstExercise = workoutPlan.exercises[0];
          document.getElementById('liftName').value = firstExercise.name;

          if (firstExercise.rpe) {
            document.getElementById('rpe').value = firstExercise.rpe;
          }

          // Clear existing sets and add new ones
          const setsBuilder = document.getElementById('setsBuilder');
          setsBuilder.innerHTML = '';
          setCount = 0;

          firstExercise.sets.forEach((set, index) => {
            setCount++;
            const setDiv = document.createElement('div');
            setDiv.className = 'set-input';
            setDiv.innerHTML = `
              <span>Set ${setCount}:</span>
              <input type="number" class="reps" placeholder="Reps" min="1" value="${set.reps}">
              <span>reps √ó</span>
              <input type="number" class="weight" placeholder="Weight" min="0" step="2.5" value="${set.weight}">
              <span>lbs</span>
              ${setCount > 1 ? '<button type="button" onclick="this.parentElement.remove(); setCount--;" class="remove-set-btn">Remove</button>' : ''}
            `;
            setsBuilder.appendChild(setDiv);
          });

        } else if (workoutPlan.type === 'cardio') {
          document.getElementById('modality').value = workoutPlan.modality || '';
          document.getElementById('duration').value = workoutPlan.duration || '';
          document.getElementById('distance').value = workoutPlan.distance || '';
          document.getElementById('avgHr').value = workoutPlan.target_hr || workoutPlan.avg_hr || '';

        } else if (workoutPlan.type === 'bjj') {
          document.getElementById('technique').value = workoutPlan.technique || '';
          document.getElementById('rounds').value = workoutPlan.rounds || '';
          document.getElementById('roundLength').value = workoutPlan.round_length || 5;
        }

        statusDiv.innerHTML = '<p style="color: #10b981;">‚úÖ Template loaded! Review and click "Add Workout" to save.</p>';

        // Close modal after a moment
        setTimeout(() => {
          closeImportModal();
        }, 2000);

      } catch (error) {
        console.error('Template error:', error);
        statusDiv.innerHTML = `<p style="color: #ef4444;">‚ùå Error: Invalid JSON format</p>`;
      }
    }
  </script>

  <!-- Import Modal -->
  <div id="importModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ü§ñ AI Workout Generator & Import</h2>
        <button class="close-btn" onclick="closeImportModal()">√ó</button>
      </div>

      <div class="modal-body">
        <p style="margin-bottom: 15px;">Generate a workout plan with AI or paste your own JSON.</p>

        <!-- AI Generation Section -->
        <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #3b82f6;">
          <h3 style="margin-top: 0; color: #1e40af;">ü§ñ AI Workout Generator</h3>

          <div class="form-group">
            <label for="apiKey">API Key (OpenAI, Claude, etc.)</label>
            <input type="password" id="apiKey" placeholder="sk-..." style="font-family: monospace;">
            <small style="color: #6b7280; display: block; margin-top: 5px;">
              Your key is stored locally and never sent to our servers
            </small>
          </div>

          <div class="form-group">
            <label for="aiProvider">AI Provider</label>
            <select id="aiProvider">
              <option value="openai">OpenAI (GPT-4)</option>
              <option value="anthropic">Anthropic (Claude)</option>
              <option value="custom">Custom Endpoint</option>
            </select>
          </div>

          <div class="form-group" id="customEndpointGroup" style="display: none;">
            <label for="customEndpoint">API Endpoint URL</label>
            <input type="url" id="customEndpoint" placeholder="https://api.example.com/v1/completions">
          </div>

          <div class="form-group">
            <label for="workoutPrompt">Describe Your Workout</label>
            <textarea id="workoutPrompt" rows="3" placeholder="E.g., Push day focusing on chest and shoulders. I can bench 185 lbs for 8 reps. Include 5 exercises with progressive overload."></textarea>
          </div>

          <button onclick="generateWithAI()" style="background: #3b82f6; width: 100%;">
            ü™Ñ Generate Workout Plan
          </button>

          <div id="aiStatus" style="margin-top: 15px;"></div>
        </div>

        <div class="form-group">
          <label for="importDate">Workout Date</label>
          <input type="date" id="importDate" style="margin-bottom: 15px;">
        </div>

        <div class="form-group">
          <label for="jsonInput">JSON Workout Plan</label>
          <textarea id="jsonInput" rows="10" placeholder='Paste your JSON here or generate one with AI above...'></textarea>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button onclick="importWorkout()">Import & Add Workouts</button>
          <button onclick="importAsTemplate()" style="background: #10b981;">Import as Template</button>
        </div>

        <div id="importStatus" style="margin-top: 15px;"></div>
      </div>

      <details style="margin-top: 20px; padding: 0 24px 24px;">
        <summary style="cursor: pointer; color: #6366f1;">üìã JSON Format Guide</summary>
        <div style="margin-top: 10px; padding: 15px; background: #f9fafb; border-radius: 8px;">
          <h4>Weight Training Format:</h4>
          <pre style="background: #1f2937; color: #f3f4f6; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 13px;">{
  "session": "Push Day",
  "type": "lift",
  "exercises": [
    {
      "name": "Bench Press",
      "sets": [
        {"reps": 8, "weight": 135},
        {"reps": 6, "weight": 155}
      ],
      "rpe": 8
    },
    {
      "name": "Shoulder Press",
      "sets": [
        {"reps": 10, "weight": 95},
        {"reps": 8, "weight": 105}
      ]
    }
  ],
  "notes": "Deload week"
}</pre>

          <h4 style="margin-top: 15px;">Cardio Format:</h4>
          <pre style="background: #1f2937; color: #f3f4f6; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 13px;">{
  "session": "Morning Run",
  "type": "cardio",
  "modality": "Running",
  "duration": 30,
  "distance": 3.5,
  "target_hr": 145
}</pre>

          <h4 style="margin-top: 15px;">BJJ Format:</h4>
          <pre style="background: #1f2937; color: #f3f4f6; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 13px;">{
  "session": "Competition Prep",
  "type": "bjj",
  "technique": "Guard Passing",
  "rounds": 8,
  "round_length": 5
}</pre>
        </div>
      </details>
    </div>
  </div>

</body>
</html>
